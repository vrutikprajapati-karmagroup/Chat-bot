<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Karma Group Chatbot</title>
    <style>
      /* General Styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
      }

      .chatbot-container {
        width: 471px;
        height: 500px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      @media (max-width: 500px) {
        .chatbot-container {
          width: 100%;
          height: 100vh;
          border-radius: 0;
        }
      }
      #contactForm {
        width: 70%;
      }

      /* Header */
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        background-color: #8b6f3d;
        border-bottom: 1px solid #e5e7eb;
      }
      .header h1 {
        font-size: 18px;
        font-weight: 600;
        color: white;
      }
      .header-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .header-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .close-icon-img {
        width: 15px;
        height: 15px;
        object-fit: contain;
      }

      /* Main */
      .main-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
      }

      /* Login */
      .login-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        gap: 24px;
        width: 100%;
        height: 100%;
        padding: 16px;
        max-width: 350px;
        margin: 0 auto;
      }
      .form-logo {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 8px;
      }
      .detail-box {
        text-align: center;
      }
      .detail-header {
        color: #8d714c;
        font-weight: 200;
        font-size: 26.47px;
        line-height: 116%;
      }

      .form-group {
        width: 100%;
        position: relative;
        margin-bottom: 24px;
      }
      .form-group input {
        width: 100%;
        padding: 8px 0;
        font-size: 14px;
        border: none;
        border-bottom: 2px solid #8d714c;
        background: transparent;
        transition: border-bottom-color 0.2s;
      }
      .form-group input:focus {
        outline: none;
      }
      .form-group label {
        position: absolute;
        top: 8px;
        left: 0;
        font-size: 14px;
        color: #8d714c;
        transition: all 0.2s ease-out;
        pointer-events: none;
      }
      .form-group input:focus + label,
      .form-group input:not(:placeholder-shown) + label {
        top: -12px;
        font-size: 12px;
        color: #8b6f3d;
        font-weight: 600;
      }
      .submit-btn {
        width: 100%;
        padding: 12px 52px;
        border: none;
        border-radius: 25px;
        background-color: #8d714c;
        color: white;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
        letter-spacing: 0.02em;
      }
      .submit-btn:hover {
        background-color: #725a33;
      }

      /* Chat */
      .chat-content {
        display: none;
        flex-direction: column;
        flex: 1;
        padding: 16px;
      }
      .chat-messages-container {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 16px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        margin-top: 2rem;
      }
      .message {
        display: flex;
        align-items: center;
        /* margin-bottom: 16px; */
      }
      .message.user {
        justify-content: flex-end;
        padding: 10px;
      }
      .message.bot {
        justify-content: flex-start;
      }
      .bot-avatar {
        width: 32px;
        height: 32px;
        margin-right: 12px;
        flex-shrink: 0;
        background-color: #8b6f3d;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
      }
      .message-bubble {
        max-width: 70%;
        background: #f7f3e8;
        border-radius: 16px;
        padding: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .message.user .message-bubble {
        background-color: #8b6f3d;
        color: white;
      }
      .message-text {
        font-size: 14px;
        color: #1f2937;
        line-height: 1.4;
      }
      .message.user .message-text {
        color: white;
      }

      .chat-options {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        margin-bottom: 15px;
      }
      .chat-option-btn {
        padding: 8px 16px;
        border: 0.5px solid #b2b2b2;
        border-radius: 20px;
        font-size: 14px;
        cursor: pointer;
        background: white;
        color: #b2b2b2;
        transition: background-color 0.2s;
      }
      .chat-option-btn:hover {
        background-color: #f3f4f6;
        background: #f0f0f0;
        border-color: #999;
        color: #000;
        text-decoration: none;
      }

      .chat-footer {
        display: flex;
        flex-direction: column;
        gap: 8px;
        /* margin-top: 1rem; */
      }
      .chat-input-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .chat-input-container {
        flex: 1;
        display: flex;
        align-items: center;
        padding: 3px;
        border-radius: 25px;
        background-color: white;
        border: 1px solid #8d714c29;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .chat-input {
        flex: 1;
        border: none;
        background: white;
        padding: 5px 10px;
        font-size: 14px;
        outline: none;
        color: #1f2937;
      }
      .chat-input::placeholder {
        color: #b2b2b2;
      }
      .chat-mic-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .chat-send-btn {
        background-color: #8d714c;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .resorts-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 15px 0px 15px 0px;
        align-items: center;
        justify-content: left;
      }
      .resorts-option-btn {
        padding: 6px 14px;
        border: 1px solid #998363;
        border-radius: 20px;
        background: #f7f3e8; /* Light beige background */
        color: #333; /* Dark text color */
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .resorts-option-btn:hover {
        background: #8d714c; /* Brown background on hover */
        color: #fff; /* White text on hover */
        border-color: #8d714c; /* Dark border on hover */
        text-decoration: none;
      }

      .resort-title {
        color: #333; /* Dark text for headings */
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
        text-align: center;
      }
      #resort-main-btns {
        padding-bottom: 10px;
        padding-left: 45px;
      }
      .back-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .back-icon-img {
        width: 15px;
        height: 15px;
        object-fit: contain;
      }
    </style>
  </head>
  <body>
    <div class="chatbot-container">
      <header class="header">
        <button
          class="header-btn back-btn"
          onclick="goBackToChat()"
          style="display: none"
        >
          <img src="images/arrow-left.svg" alt="Back" class="back-icon-img" />
        </button>
        <h1>Karma Group</h1>
        <div class="header-actions">
          <button class="header-btn" onclick="closeChat()">
            <img
              src="images/button-closer.svg"
              alt="Close"
              class="close-icon-img"
            />
          </button>
        </div>
      </header>

      <main class="main-content" id="main-content"></main>
    </div>

    <!-- Your mic-to-text logic in a separate file -->
    <script src="mic-to-text.js"></script>
    <script>
      let resortData = null;
      fetch("karma-royal-haathi-mahal (1).json")
        .then((res) => res.json())
        .then((data) => {
          resortData = data.resort;
        });
    </script>

    <script>
      let currentPage = "login";
      let userName = "";
      let messages = [];

      const mainContent = document.getElementById("main-content");
      const NAME_KEY = "kg_chat_name";

      function clearChatStorage() {
        try {
          localStorage.removeItem(NAME_KEY);
        } catch {}
      }

      function scrollChatToBottom() {
        // Scroll the main content container (which includes messages and input)
        const mainContent = document.getElementById("main-content");
        // console.log(mainContent.scrollHeight);
        if (mainContent) {
          mainContent.scrollTop = mainContent.scrollHeight;
          console.log(mainContent.scrollHeight);
        }
      }
      function closeChat() {
        clearChatStorage();
        userName = "";
        messages = [];
        currentPage = "login";
        document.querySelector(".chatbot-container").style.display = "none";
      }

      function openChat() {
        const container = document.querySelector(".chatbot-container");
        container.style.display = "flex";
        currentPage = "login";
        renderApp();
      }
      window.openChat = openChat;

      function renderLoginForm() {
        mainContent.innerHTML = `
        <div class="login-content">
          <div class="form-logo">
            <img src="images/header-bot.svg" alt="Bot">
          </div>
          <div class="detail-box">
            <h2 class="detail-header">Please fill your details</h2>
          </div>
          <form id="contactForm">
            <div class="form-group">
              <input type="text" id="name" name="name" placeholder=" " required autocomplete="name">
              <label for="name">Name</label>
            </div>
            <div class="form-group">
              <input type="email" id="email" name="email" placeholder=" " required autocomplete="email">
              <label for="email">Email</label>
            </div>
            <div class="form-group">
              <input type="text" id="memberNo" name="memberNo" placeholder=" " autocomplete="off">
              <label for="memberNo">Member No.</label>
            </div>
            <button type="submit" class="submit-btn">Start Chat</button>
          </form>
        </div>
      `;
        document
          .getElementById("contactForm")
          .addEventListener("submit", handleFormSubmit);
      }

      function renderChat() {
        mainContent.innerHTML = `
        <div class="chat-content" style="display:flex;">
          <div class="form-logo">
            <img src="images/header-bot.svg" alt="Bot">
          </div>

          <div class="chat-messages-container" id="chat-messages"></div>

          <div class="chat-options" id="chat-options">
            <button class="chat-option-btn" onclick="handleChatOption('Resort Info')">Resort Info</button>
            <button class="chat-option-btn" onclick="handleChatOption('AI Help')">AI Help</button>
            <a href="https://karmaclub.karmagroup.com/member/hot-deals/" target="_blank"
              class="chat-option-btn" style="text-decoration: none;">
              HOT DEALS
            </a>
          </div>

          <div class="chat-footer">
            <div class="chat-input-row">
              <div class="chat-input-container">
                <input type="text" class="chat-input" id="chat-input" placeholder="Ask or press the mic">
                <button class="chat-mic-btn" id="mic-btn" aria-pressed="false" onclick="toggleMic()">
                  <img src="images/mic-icon.svg" alt="Mic">
                </button>
              </div>
              <button class="chat-send-btn" id="chat-send-btn" onclick="sendFromInput()">
                <img src="images/send-button.svg" alt="Send">
              </button>
            </div>
          </div>
        </div>
      `;
        addMessage("bot", `Hey, ${userName || "there"}! How can I help?`);
      }

      function goBackToChat() {
        currentPage = "chat";
        renderApp();
        document.querySelector(".back-btn").style.display = "none";
      }

      function renderInfoPage(option) {
        mainContent.innerHTML = `
    <div class="info-page">
      <div class="form-logo">
        <img src="images/header-bot.svg" alt="Bot">
      </div>
      <div class="chat-messages-container" id="chat-messages">
        <div class="message bot">
          <div class="bot-avatar">
            <img src="images/bot-avatar.svg" alt="Bot Avatar" style="width:32px;height:32px;">
          </div>
          <div class="message-bubble">
            <div class="message-text">Hey, ${
              userName || "there"
            }!<br>How can I help?</div>
          </div>
        </div>
        <div class="message user">
          <div class="message-bubble">
            <div class="message-text">${option}</div>
          </div>
        </div>
        <div class="message bot">
          <div class="bot-avatar">
            <img src="images/bot-avatar.svg" alt="Bot Avatar" style="width:32px;height:32px;">
          </div>
          <div class="message-bubble">
            <div class="message-text">
              ${
                option === "Resort Info"
                  ? "Select a resort to know more:"
                  : "Sure! Ask me anything and I'll try my best to help."
              }
            </div>
          </div>
        </div>
      </div>
      <div id="resort-main-btns"></div>
      <div id="resort-main-detail"></div>
      <div class="chat-footer">
        <div class="chat-input-row">
          <div class="chat-input-container">
            <input type="text" class="chat-input" id="chat-input" placeholder="Ask or press the mic">
            <button class="chat-mic-btn" id="mic-btn" aria-pressed="false" onclick="toggleMic()">
              <img src="images/mic-icon.svg" alt="Mic">
            </button>
          </div>
          <button class="chat-send-btn" onclick="sendFromInput()">
            <img src="images/send-button.svg" alt="Send">
          </button>
        </div>
      </div>
    </div>
  `;

        document.querySelector(".back-btn").style.display = "flex";

        if (option === "Resort Info") {
          if (resortData && resortData.name) {
            renderResortMainButton();
          } else {
            setTimeout(() => renderInfoPage(option), 100);
          }
        }
      }

      function renderResortMainButton() {
        const btnsDiv = document.getElementById("resort-main-btns");
        btnsDiv.innerHTML = "";
        const btn = document.createElement("button");
        btn.className = "resorts-option-btn";
        btn.textContent = resortData.name;
        btn.onclick = () => {
          // Remove the resort button after click
          btnsDiv.innerHTML = "";

          // Add user message for clicking the button
          addMessage("user", resortData.name);

          // Add bot message with the resort description (intro)
          const intro =
            resortData.intros &&
            resortData.intros.web &&
            resortData.intros.web.text
              ? resortData.intros.web.text
              : "No description available.";
          addMessage("bot", `<strong>${resortData.name}</strong><br>${intro}`);

          // Add section buttons as a bot message
          if (resortData.sections && resortData.sections.length) {
            const sectionBtnsDiv = document.createElement("div");
            sectionBtnsDiv.className = "resorts-options";
            resortData.sections.forEach((section, idx) => {
              const sectionBtn = document.createElement("button");
              sectionBtn.className = "resorts-option-btn";
              sectionBtn.textContent = section.hl;
              // Fact Sheet: redirect only, no message
              if (
                section.hl === "Fact Sheet" &&
                section.cta &&
                section.cta.url
              ) {
                sectionBtn.onclick = (e) => {
                  e.stopPropagation();
                  window.open(section.cta.url, "_blank");
                };
              } else {
                sectionBtn.onclick = () => {
                  addMessage("user", section.hl);
                  showResortSectionChat(idx);
                };
              }
              sectionBtnsDiv.appendChild(sectionBtn);
            });
            addBotElement(sectionBtnsDiv);
          }
        };
        btnsDiv.appendChild(btn);
      }

      // Helper to add a DOM element as a bot message in chat
      function addBotElement(element) {
        const chatMessagesDiv = document.getElementById("chat-messages");
        if (!chatMessagesDiv) return;
        const messageElement = document.createElement("div");
        messageElement.className = "message bot";
        messageElement.innerHTML = `
    <div class="bot-avatar">
      <img src="images/bot-avatar.svg" alt="Bot Avatar" style="width:32px;height:32px;">
    </div>
  `;
        messageElement.appendChild(element);
        chatMessagesDiv.appendChild(messageElement);
        // setTimeout(() => {
        //   chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight + 1000;
        // }, 0);
      }

      // Show section details in chat style
      function showResortSectionChat(sectionIdx) {
        const section = resortData.sections[sectionIdx];
        let html = `<strong style="color:#8b6f3d;">${section.hl}</strong><br>`;
        if (section.copy) html += `<p>${section.copy}</p>`;
        if (section.address) {
          html += `<p><strong>Address:</strong><br>
      ${section.address.line1 || ""}<br>
      ${section.address.line2 || ""}<br>
      ${section.address.line3 || ""}<br>
      ${section.address.line4 || ""}<br>
      ${section.address.postal_code || ""}, ${section.address.country || ""}
    </p>`;
        }
        if (section.contact) {
          html += `<p><strong>Contact:</strong><br>
      Phone: ${section.contact.phone || ""}<br>
      Email: ${section.contact.email || ""}
    </p>`;
        }
        if (section.note) {
          html += `<p>${section.note}</p>`;
        }
        addMessage("bot", html);

        // If section has categories, show buttons for them
        if (section.categories && section.categories.length) {
          const catDiv = document.createElement("div");
          catDiv.className = "resorts-options";
          section.categories.forEach((cat) => {
            if (!cat.shl) return;
            const catBtn = document.createElement("button");
            catBtn.className = "resorts-option-btn";
            catBtn.textContent = cat.shl;
            catBtn.onclick = () => {
              addMessage("user", cat.shl);
              showCategoryDetailChat(cat);
            };
            catDiv.appendChild(catBtn);
          });
          addBotElement(catDiv);
        }
      }

      // Show category details in chat style
      function showCategoryDetailChat(cat) {
        let html = `<strong style="color:#8b6f3d;">${
          cat.shl || ""
        }</strong><br>`;
        if (cat.description) html += `<p>${cat.description}</p>`;
        if (cat.occupancy) {
          html += `<p><strong>Occupancy:</strong> ${cat.occupancy.adults} adults`;
          if (cat.occupancy.children_under_10)
            html += `, ${cat.occupancy.children_under_10} child(ren) under 10`;
          html += `</p>`;
        }
        if (cat.amenities && cat.amenities.length) {
          html += `<p><strong>Amenities:</strong></p><ul style="padding-left: 10px;">`;
          cat.amenities.forEach((am) => (html += `<li>${am}</li>`));
          html += `</ul>`;
        }
        if (cat.extras && cat.extras.length) {
          html += `<p><strong>Extras:</strong></p><ul style="padding-left: 10px;>`;
          cat.extras.forEach((ex) => (html += `<li>${ex}</li>`));
          html += `</ul>`;
        }
        addMessage("bot", html);
      }
      function addMessage(sender, text) {
        const chatMessagesDiv = document.getElementById("chat-messages");
        if (!chatMessagesDiv) {
          console.error("Chat messages container not found!");
          return;
        }
        if (!chatMessagesDiv) return;
        const messageElement = document.createElement("div");
        messageElement.className = `message ${sender}`;

        let html = "";
        if (sender === "bot") {
          html += `
          <div class="bot-avatar">
            <img src="images/bot-avatar.svg" alt="Bot Avatar" style="width:32px;height:32px;">
          </div>`;
        }
        html += `
        <div class="message-bubble">
          <div class="message-text">${text}</div>
        </div>`;
        messageElement.innerHTML = html;
        chatMessagesDiv.appendChild(messageElement);

        // setTimeout(() => {
        //   chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight + 1000;
        // }, 0);
        scrollChatToBottom();
      }

      async function askGeminiDirect(question) {
        addMessage("user", question);
        addMessage("bot", "Thinking...");
        try {
          const response = await fetch(
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-goog-api-key": "AIzaSyB-qGvWbybdFlEjvs3Wby23LY6e5HOv2ps",
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [{ text: question }],
                  },
                ],
              }),
            }
          );
          const data = await response.json();
          // Remove "Thinking..." message
          const chatMessagesDiv = document.getElementById("chat-messages");
          if (
            chatMessagesDiv &&
            chatMessagesDiv.lastChild &&
            chatMessagesDiv.lastChild.classList.contains("bot")
          ) {
            chatMessagesDiv.removeChild(chatMessagesDiv.lastChild);
          }
          const answer =
            data?.candidates?.[0]?.content?.parts?.[0]?.text ||
            "Sorry, I couldn't fetch the answer.";
          addMessage("bot", answer);
        } catch (e) {
          addMessage("bot", "Sorry, there was an error connecting to the AI.");
        }
      }

      // function sendFromInput() {
      //   const input = document.getElementById("chat-input");
      //   if (!input) return;
      //   const val = (input.value || "").trim();
      //   if (!val) return;
      //   addMessage("user", val);
      //   input.value = "";
      // }
      function sendFromInput() {
        const input = document.getElementById("chat-input");
        if (!input) return;
        const val = (input.value || "").trim();
        if (!val) return;
        askGeminiDirect(val);
        input.value = "";
      }
      function handleFormSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        userName = (data.name || "").trim();
        currentPage = "chat";
        renderApp();
      }

      function renderApp() {
        if (currentPage === "login") renderLoginForm();
        else if (currentPage === "chat") renderChat();
      }

      function handleChatOption(option) {
        if (option === "Resort Info" || option === "AI Help") {
          renderInfoPage(option);
        } else {
          addMessage("user", option);
          console.log(`User selected: ${option}`);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        clearChatStorage();
        userName = "";
        messages = [];
        currentPage = "login";
        renderApp();

        document.addEventListener("keydown", (event) => {
          const input = document.getElementById("chat-input");
          if (input && event.key === "Enter") {
            event.preventDefault();
            sendFromInput();
          }
        });
      });
    </script>
  </body>
</html>
