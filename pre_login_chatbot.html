<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Karma Group Chatbot</title>
  <style>
    /* test your original styles, unchanged except a couple tiny additions */
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background-color:#f3f4f6;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;}
    .chatbot-container{width:471px;height:500px;background:white;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.1);overflow:hidden;display:flex;flex-direction:column;}
    @media (max-width:500px){.chatbot-container{width:100%;height:100vh;border-radius:0;}}
    .header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background-color:#8b6f3d;border-bottom:1px solid #e5e7eb;}
    .header h1{font-size:18px;font-weight:600;color:white;}
    .header-actions{display:flex;align-items:center;gap:10px;}
    .header-btn{background:transparent;border:none;cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center;}
    .close-icon-img{width:15px;height:15px;object-fit:contain;}

    .main-content{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;}

    .login-content{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:24px;width:100%;height:100%;padding:16px;max-width:350px;margin:0 auto;}
    .form-logo{width:100%;display:flex;justify-content:center;align-items:center;margin-bottom:8px;}
    .detail-box{text-align:center;}
    .detail-header{color:#8D714C;font-weight:200;font-size:26.47px;line-height:116%;}
    #contactForm{width:70%;}
    .form-group{width:100%;position:relative;margin-bottom:24px;}
    .form-group input{width:100%;padding:8px 0;font-size:14px;border:none;border-bottom:2px solid #8D714C;background:transparent;transition:border-bottom-color .2s;}
    .form-group input:focus{outline:none;}
    .form-group label{position:absolute;top:8px;left:0;font-size:14px;color:#8D714C;transition:all .2s ease-out;pointer-events:none;}
    .form-group input:focus+label,.form-group input:not(:placeholder-shown)+label{top:-12px;font-size:12px;color:#8b6f3d;font-weight:600;}
    .submit-btn{width:100%;padding:12px 52px;border:none;border-radius:25px;background-color:#8d714c;color:white;font-size:14px;font-weight:500;cursor:pointer;transition:background-color .2s;letter-spacing:.02em;}
    .submit-btn:hover{background-color:#725a33;}

    .chat-content{display:none;flex-direction:column;flex:1;padding:16px;}
    .chat-messages-container{flex:1;overflow-y:auto;margin-bottom:16px;display:flex;flex-direction:column;justify-content:flex-end;margin-top:2rem;}
    .message{display:flex;align-items:center;margin-bottom:16px;}
    .message.user{justify-content:flex-end;}
    .message.bot{justify-content:flex-start;}
    .bot-avatar{width:32px;height:32px;margin-right:12px;flex-shrink:0;background-color:#8b6f3d;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:14px;}
    .message-bubble{max-width:70%;background:#F7F3E8;border-radius:16px;padding:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
    .message.user .message-bubble{background-color:#8b6f3d;color:white;}
    .message-text{font-size:14px;color:#1f2937;line-height:1.4;}
    .message.user .message-text{color:white;}

    .chat-options{display:flex;gap:8px;margin-top:8px;}
    .chat-option-btn{padding:8px 16px;border:.5px solid #B2B2B2;border-radius:20px;font-size:14px;cursor:pointer;background:white;color:#B2B2B2;transition:background-color .2s;}
    .chat-option-btn:hover{background-color:#f3f4f6;}
    .chat-footer{display:flex;align-items:center;gap:8px;margin-top:1rem;}
    .chat-input-container{flex:1;display:flex;align-items:center;padding:3px;border-radius:25px;background-color:white;border:1px solid #8D714C29;box-shadow:0 2px 4px rgba(0,0,0,.05);}
    .chat-input{flex:1;border:none;background:white;padding:5px 10px;font-size:14px;outline:none;color:#1f2937;}
    .chat-input::placeholder{color:#B2B2B2;}
    .chat-mic-btn{background:transparent;border:none;cursor:pointer;padding:8px;display:flex;align-items:center;justify-content:center;}
    .chat-send-btn{background-color:#8D714C;border:none;border-radius:50%;cursor:pointer;width:48px;height:48px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 4px rgba(0,0,0,.1);}

    /* voice-to-text status */
    .sr-status{font-size:12px;color:#6b7280;text-align:center;margin-top:4px;}
    .sr-error{font-size:12px;color:#b91c1c;text-align:center;margin-top:2px;}
  </style>
</head>
<body>
  <div class="chatbot-container">
    <header class="header">
      <h1>Karma Group</h1>
      <div class="header-actions">
        <button class="header-btn" onclick="closeChat()">
          <img src="images/button-closer.svg" alt="Close" class="close-icon-img">
        </button>
      </div>
    </header>

    <main class="main-content" id="main-content"></main>

    <!-- Voice-to-Text status area (shown only on chat page) -->
    <div id="sr-status" class="sr-status" aria-live="polite"></div>
    <div id="sr-error" class="sr-error" aria-live="assertive"></div>
  </div>

  <script>
    let currentPage='login';
    let userName='';
    let messages=[];

    const mainContent=document.getElementById('main-content');

    function closeChat(){ document.querySelector('.chatbot-container').style.display='none'; }

    function renderLoginForm(){
      mainContent.innerHTML = `
        <div class="login-content">
          <div class="form-logo">
            <img src="images/header-bot.svg" alt="Bot">
          </div>
          <div class="detail-box">
            <h2 class="detail-header">Please fill your details</h2>
          </div>
          <form id="contactForm">
            <div class="form-group">
              <input type="text" id="name" name="name" placeholder=" " required autocomplete="name">
              <label for="name">Name</label>
            </div>
            <div class="form-group">
              <input type="email" id="email" name="email" placeholder=" " required autocomplete="email">
              <label for="email">Email</label>
            </div>
            <div class="form-group">
              <input type="text" id="memberNo" name="memberNo" placeholder=" " autocomplete="off">
              <label for="memberNo">Member No.</label>
            </div>
            <button type="submit" class="submit-btn">Start Chat</button>
          </form>
        </div>`;
      document.getElementById('contactForm').addEventListener('submit', handleFormSubmit);
      // hide status banners on login
      setStatus(''); setError('');
    }

    function renderChat(){
      mainContent.innerHTML = `
        <div class="chat-content" style="display:flex;flex-direction:column;flex:1;">
          <div class="form-logo">
            <img src="images/header-bot.svg" alt="Bot">
          </div>

          <div class="chat-messages-container" id="chat-messages"></div>

          <div class="chat-options" id="chat-options">
            <button class="chat-option-btn" onclick="handleChatOption('Resort Info')">Resort Info</button>
            <button class="chat-option-btn" onclick="handleChatOption('AI Help')">AI Help</button>
          </div>

          <div class="chat-footer">
            <div class="chat-input-container">
              <input type="text" class="chat-input" id="chat-input" placeholder="Ask" aria-label="Ask"/>
              <button class="chat-mic-btn" id="mic-btn" aria-pressed="false" onclick="toggleMic()" title="Start voice input" aria-label="Voice input">
                <img src="images/mic-icon.svg" alt="Mic">
              </button>
            </div>
            <button class="chat-send-btn" onclick="handleSendClick()" aria-label="Send">
              <img src="images/send-button.svg" alt="Send">
            </button>
          </div>
        </div>`;

      addMessage('bot', `Hey, ${userName}! How can I help?`);
      const input = document.getElementById('chat-input'); if (input) input.focus();
      setStatus(''); setError('');
    }

    function renderApp(){ currentPage==='login' ? renderLoginForm() : renderChat(); }

    function addMessage(sender,text){
      const chatMessagesDiv=document.getElementById('chat-messages'); if(!chatMessagesDiv) return;
      const messageElement=document.createElement('div');
      messageElement.className=`message ${sender}`;

      let messageHTML='';
      if(sender==='bot'){
        messageHTML+=`<div class="bot-avatar">
          <img src="images/bot-avatar.svg" alt="Bot Avatar" style="width:32px;height:32px;">
        </div>`;
      }
      messageHTML+=`<div class="message-bubble"><div class="message-text">${escapeHtml(text)}</div></div>`;
      messageElement.innerHTML=messageHTML;
      chatMessagesDiv.appendChild(messageElement);
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    }

    function handleFormSubmit(e){
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      userName = (data.name || '').trim();
      currentPage='chat';
      renderApp();
    }

    function handleChatOption(option){
      addMessage('user', option);
      addMessage('bot', option==='Resort Info'
        ? "I'd love to help! Just type the resort name or location you’re interested in"
        : "Sure! Ask me anything and I'll try my best to help.");
    }

    function handleSendClick(){
      const inp=document.getElementById('chat-input');
      if(!inp) return;
      const txt=(inp.value||'').trim();
      if(!txt) return;
      addMessage('user', txt);
      inp.value='';
      // TODO: replace with your real bot call
      setTimeout(()=>addMessage('bot','Got it! Anything else?'), 500);
    }

    /* ------------------ Voice-to-Text (Web Speech API) ------------------ */
    let recognition=null, isListening=false;

    function setStatus(m){ const el=document.getElementById('sr-status'); if(el) el.textContent = m || ''; }
    function setError(m){ const el=document.getElementById('sr-error'); if(el) el.textContent = m || ''; }

    function createRecognition(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) return null;
      const r = new SR();
      // change to 'en-IN' if you prefer Indian English
      r.lang = document.documentElement.lang || 'en-US';
      r.continuous = true;
      r.interimResults = true;
      r.maxAlternatives = 1;
      return r;
    }

    function toggleMic(){
      setError('');
      if(!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)){
        setError('Speech recognition not supported (try Chrome/Edge or Safari iOS 16+).');
        return;   
      }
      if(currentPage!=='chat'){
        setError('Start chat first to use the microphone.');
        return;
      }
      if(isListening){ stopListening(); } else { startListening(); }
    }

    function startListening(){
    debugger;
      const input = document.getElementById('chat-input');
      if(!input){ setError('Input not ready.'); return; }

      recognition = createRecognition();
      if(!recognition){ setError('Recognition API unavailable.'); return; }

      let finalText = '';

      recognition.onstart = () => {
        isListening = true;
        setStatus('🎙️ Listening…');
        const mic=document.getElementById('mic-btn'); if(mic) mic.setAttribute('aria-pressed','true');
        input.placeholder='Listening…';
      };

      recognition.onresult = (e) => {
        let interim = '';
        for(let i=e.resultIndex; i<e.results.length; i++){
          const r=e.results[i];
          if(r.isFinal) finalText += r[0].transcript;
          else interim += r[0].transcript;
        }
        input.value = (finalText + ' ' + interim).trim();
      };

      recognition.onerror = (e) => {
        setError('Voice error: ' + e.error);
        stopListening(false);
      };

      recognition.onend = () => {
        setStatus('');
        isListening = false;
        const mic=document.getElementById('mic-btn'); if(mic) mic.setAttribute('aria-pressed','false');
        if(input){
          input.placeholder='Ask';
          if(input.value.trim()){
            // emulate send on stop
            handleSendClick();
          }
        }
      };

      try { recognition.start(); }
      catch(err){ setError('Could not start recognition. Try again.'); }
    }

    function stopListening(reset=false){
      const input = document.getElementById('chat-input');
      if(recognition){ try{ recognition.stop(); }catch(_){} recognition=null; }
      isListening=false;
      setStatus('');
      const mic=document.getElementById('mic-btn'); if(mic) mic.setAttribute('aria-pressed','false');
      if(reset && input) input.value='';
      if(input) input.placeholder='Ask';
    }

    /* ------------------ Helpers ------------------ */
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[s]));
    }

    document.addEventListener('DOMContentLoaded', renderApp);
  </script>
</body>
</html>
