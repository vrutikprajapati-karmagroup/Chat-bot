<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Karma Group Chatbot</title>
  <style>
    * {margin:0;padding:0;box-sizing:border-box;}
    body {font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f3f4f6;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;}
    .chatbot-container {width:471px;height:500px;background:white;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.1);overflow:hidden;display:flex;flex-direction:column;}
    @media(max-width:500px){.chatbot-container{width:100%;height:100vh;border-radius:0;}}
    .header {display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#8b6f3d;}
    .header h1 {font-size:18px;font-weight:600;color:white;}
    .header-btn {background:transparent;border:none;cursor:pointer;display:flex;align-items:center;color:#fff;font-size:18px;}
    .main-content {flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;}
    .form-logo {display:flex;justify-content:center;align-items:center;margin-bottom:8px;}
    .bot-avatar {width:32px;height:32px;background:#8b6f3d;color:#fff;display:flex;align-items:center;justify-content:center;border-radius:50%;font-weight:bold;}
    .login-content {margin:auto;text-align:center;width:100%;max-width:350px;}
    .detail-header {color:#8D714C;font-size:24px;margin-bottom:20px;}
    .form-group{position:relative;margin-bottom:20px;}
    .form-group input{width:100%;padding:8px 0;border:none;border-bottom:2px solid #8D714C;background:transparent;font-size:14px;}
    .form-group label{position:absolute;left:0;top:8px;color:#8D714C;transition:.2s;font-size:14px;pointer-events:none;}
    .form-group input:focus+label,.form-group input:not(:placeholder-shown)+label{top:-12px;font-size:12px;font-weight:600;}
    .submit-btn{width:100%;padding:12px;border:none;border-radius:25px;background:#8d714c;color:#fff;cursor:pointer;}
    .chat-messages-container{flex:1;overflow-y:auto;margin-bottom:10px;display:flex;flex-direction:column;justify-content:flex-end;}
    .message{display:flex;margin-bottom:12px;}
    .message.user{justify-content:flex-end;}
    .message-bubble{max-width:70%;background:#f7f3e8;border-radius:16px;padding:10px;}
    .message.user .message-bubble{background:#8b6f3d;color:#fff;}
    .chat-footer{display:flex;align-items:center;gap:8px;padding:10px;border-top:1px solid #eee;background:#fff;}
    .chat-input-container{flex:1;display:flex;align-items:center;border:1px solid #ccc;border-radius:20px;padding:3px 8px;background:#fff;}
    .chat-input{flex:1;border:none;outline:none;padding:6px;font-size:14px;}
    .chat-mic-btn,.chat-send-btn{background:none;border:none;cursor:pointer;}
    .chat-send-btn{background:#8D714C;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:16px;}
    .sr-status{font-size:12px;color:#6b7280;text-align:center;padding:2px 0;}
    .sr-error{font-size:12px;color:#b91c1c;text-align:center;padding-bottom:6px;}
  </style>
</head>
<body>
  <div class="chatbot-container">
    <header class="header">
      <h1>Karma Group</h1>
      <button class="header-btn" onclick="closeChat()" aria-label="Close">‚úñ</button>
    </header>

    <main class="main-content" id="main-content"></main>

    <!-- Ask toolbar: hidden on login, shown after Start Chat -->
    <div id="ask-bar" style="display:none;">
      <div class="chat-footer">
        <div class="chat-input-container">
          <input type="text" class="chat-input" id="chat-input" placeholder="Ask" aria-label="Type your message">
          <button class="chat-mic-btn" id="mic-btn" aria-pressed="false" onclick="toggleMic()" title="Start voice input" aria-label="Voice input">üéôÔ∏è</button>
        </div>
        <button class="chat-send-btn" onclick="handleSendClick()" aria-label="Send">‚û§</button>
      </div>
      <div id="sr-status" class="sr-status"></div>
      <div id="sr-error" class="sr-error"></div>
    </div>
  </div>

<script>
/* ---------- App State ---------- */
let currentPage='login';
let userName='';
let messages=[];
const mainContent=document.getElementById('main-content');

/* ---------- Utilities ---------- */
function el(id){return document.getElementById(id);}
function closeChat(){document.querySelector('.chatbot-container').style.display='none';}

/* ---------- Renderers ---------- */
function renderLoginForm(){
  // Hide Ask bar on login
  const askBar = el('ask-bar'); if(askBar) askBar.style.display='none';

  mainContent.innerHTML=`
    <div class="login-content">
      <div class="form-logo"><div class="bot-avatar" aria-hidden="true">K</div></div>
      <h2 class="detail-header">Please fill your details</h2>
      <form id="contactForm">
        <div class="form-group">
          <input type="text" id="name" name="name" placeholder=" " required autocomplete="name">
          <label for="name">Name</label>
        </div>
        <div class="form-group">
          <input type="email" id="email" name="email" placeholder=" " required autocomplete="email">
          <label for="email">Email</label>
        </div>
        <button type="submit" class="submit-btn">Start Chat</button>
      </form>
    </div>`;
  el('contactForm').addEventListener('submit',handleFormSubmit);
}

function renderChat(){
  // Show Ask bar once chat starts
  const askBar = el('ask-bar'); if(askBar) askBar.style.display='block';

  mainContent.innerHTML=`
    <div class="chat-messages-container" id="chat-messages"></div>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <button onclick="handleChatOption('Resort Info')">Resort Info</button>
      <button onclick="handleChatOption('AI Help')">AI Help</button>
    </div>`;

  addMessage('bot',`Hey, ${userName}! How can I help?`);

  // Focus input so user can type or hit mic immediately
  const input = el('chat-input');
  if (input) input.focus();
}

function renderApp(){ currentPage==='login' ? renderLoginForm() : renderChat(); }

/* ---------- Chat helpers ---------- */
function addMessage(sender,text){
  const chat=el('chat-messages'); if(!chat) return;
  const div=document.createElement('div'); div.className=`message ${sender}`;
  div.innerHTML=`<div class="message-bubble"></div>`;
  div.querySelector('.message-bubble').textContent=text;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}

function handleFormSubmit(e){
  e.preventDefault();
  userName = el('name').value.trim();
  currentPage='chat';
  renderApp();
}

function handleChatOption(opt){
  addMessage('user',opt);
  addMessage('bot', opt==='Resort Info' ? 'Please type the resort name or location' : 'Sure! Ask me anything.');
}

function handleSendClick(){
  const inp=el('chat-input');
  if(!inp) return;
  const txt=inp.value.trim();
  if(txt){
    addMessage('user',txt);
    inp.value='';
    // Simulated bot response
    setTimeout(()=>addMessage('bot','Got it! Anything else?'),600);
  }
}

/* ---------- Speech-to-Text (Web Speech API) ---------- */
let recognition=null, isListening=false;

function setStatus(m){ el('sr-status').textContent = m || ''; }
function setError(m){ el('sr-error').textContent = m || ''; }

function createRecognition(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return null;
  const r = new SR();
  r.lang = document.documentElement.lang || 'en-US'; // change to 'en-IN' if preferred
  r.continuous = true;
  r.interimResults = true;
  r.maxAlternatives = 1;
  return r;
}

function toggleMic(){
  setError('');
  if(!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)){
    setError('Speech recognition not supported in this browser (try Chrome/Edge or Safari iOS 16+).');
    return;
  }
  // Only allow mic on chat page where input exists
  if(currentPage !== 'chat'){
    setError('Start chat first to use the microphone.');
    return;
  }
  if(isListening){ stopListening(); } else { startListening(); }
}

function startListening(){
  const input = el('chat-input');
  if(!input){ setError('Input not ready.'); return; }

  recognition = createRecognition();
  if(!recognition){ setError('Recognition API unavailable.'); return; }

  let finalText = '';

  recognition.onstart = () => {
    isListening = true;
    setStatus('üéôÔ∏è Listening‚Ä¶');
    el('mic-btn')?.setAttribute('aria-pressed','true');
    input.placeholder = 'Listening‚Ä¶';
  };

  recognition.onresult = (e) => {
    let interim = '';
    for(let i=e.resultIndex; i<e.results.length; i++){
      const r = e.results[i];
      if(r.isFinal) finalText += r[0].transcript;
      else interim += r[0].transcript;
    }
    input.value = (finalText + ' ' + interim).trim();
  };

  recognition.onerror = (e) => {
    setError('Error: ' + e.error);
    stopListening(false);
  };

  recognition.onend = () => {
    // User stopped talking OR we called stop()
    setStatus('');
    isListening = false;
    el('mic-btn')?.setAttribute('aria-pressed','false');
    const inputNow = el('chat-input');
    if(inputNow){
      inputNow.placeholder = 'Ask';
      // Auto-send exactly like pressing the Send button
      if(inputNow.value.trim()){
        handleSendClick();
      }
    }
  };

  try { recognition.start(); }
  catch(err){ setError('Could not start recognition. Try again.'); }
}

function stopListening(resetValue=false){
  const input = el('chat-input');
  if(recognition){ try{ recognition.stop(); }catch(_){} recognition=null; }
  isListening = false;
  setStatus('');
  el('mic-btn')?.setAttribute('aria-pressed','false');
  if(input){
    input.placeholder='Ask';
    if(resetValue) input.value='';
  }
}

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded', renderApp);
</script>
</body>
</html>
